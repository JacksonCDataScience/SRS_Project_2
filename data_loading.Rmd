---
output:
pdf_document: default
---

```{r}

library(ncdf4)
library(terra)
library(tidyr)
library(dplyr)

```

# Opening the data

```{r}

data <- nc_open("temp_data_SRS.nc")

print(data)
```


```{r}

# put data into table (first year only as the data is huge)

# extract time
time <- ncvar_get(data, "time")

# load data as raster stack
r <- rast("temp_data_SRS.nc")

# convert time to actual dates
dates <- as.Date(time, origin = "1900-01-01")

# find first year
first_year <- format(min(dates), "%Y")
idx_first_year <- which(format(dates, "%Y") == first_year)
r_first_year <- r[[idx_first_year]]
names(r_first_year) <- format(dates[idx_first_year], "%b")  # Jan, Feb, etc.

# convert to long-format table
# xy = TRUE keeps lon/lat
# long = TRUE makes tidy table (one row per cell per time)
# remove any row where the value column (tmp) is NA
df_first_year <- as.data.frame(
  r_first_year,
  xy = TRUE,
  long = TRUE,
  na.rm = TRUE
)
names(df_first_year)[1:2] <- c("lon","lat")
df_first_year$long <- NULL


# reformat it so each row is unique coordinate,time combo
df_first_year <- df_first_year %>%
  pivot_longer(
    cols = Jan:Dec,         
    names_to = "month",    
    values_to = "tmp"
  )


# how many duplicates

print(nrow(df_first_year))

print(nrow(unique(df_first_year)))




```





```{r}


# load raster and time
r <- rast("temp_data_SRS.nc")
time <- ncvar_get(data, "time")
dates <- as.Date(time, origin = "1900-01-01")
years <- unique(format(dates, "%Y"))

# output CSV file (all years in one)
csv_file <- "tmp_all_years.csv"

# track if we need to write header
write_header <- TRUE

for (y in years) {
  cat("Processing year:", y, "\n")
  
  # indices for this year
  idx <- which(format(dates, "%Y") == y)
  
  # subset raster stack for this year
  r_year <- r[[idx]]
  
  for (i in seq_along(idx)) {
    df_tmp <- as.data.frame(r_year[[i]], xy = TRUE, long = TRUE, na.rm = TRUE)
    names(df_tmp)[1:2] <- c("lon", "lat")
    df_tmp$long <- NULL
    df_tmp$year <- y
    df_tmp$month <- format(dates[idx[i]], "%b")
    
    # append to CSV
    write.table(
      df_tmp,
      file = csv_file,
      append = !write_header,
      sep = ",",
      row.names = FALSE,
      col.names = write_header
    )
    
    write_header <- FALSE  # header written only once
    rm(df_tmp)
    gc()
  }
  
  rm(r_year)
  gc()
}

```







